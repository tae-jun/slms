/// <reference path="../../scripts/typings/jasmine/jasmine.d.ts" />
import groups = require('../../lib/mongo/groups');
import lights = require('../../lib/mongo/lights');

describe('Collection groups', () => {

    var testGroup: groups.Group;
    
    it('should be connected to mongodb', (done) => {
        if (groups.isConnected)
            done();
        else groups.done = done;
    });
    
    it('should create a doc', (done) => {
        testGroup = new groups.Group();
        testGroup.name = 'test group';

        groups.create(testGroup, (result) => {
            expect(result._id).toBeDefined();
            testGroup = result;
            done();
        });
    });

    it('should find a group', (done) => {
        groups.findByID(testGroup._id, (item) => {
            expect(item).toEqual(testGroup);
            done();
        });
    });

    it('should find all groups', (done) => {
        groups.findAll((items) => {
            expect(items.length).toBeGreaterThan(0);
            expect(items).toContain(testGroup);
            done();
        });
    });

    it('should update a group', (done) => {
        groups.update(testGroup._id, { name: 'changed' }, (result) => {
            expect(result).toBe(1);

            groups.findByID(testGroup._id, (item) => {
                expect(item.name).toBe('changed');
                testGroup = item;
                done();
            });
        });
    });

    describe('Function remove', () => {
        var testLightsNum: number = 5;
        var testLights: lights.Light[];

        it('create test lights', (done) => {
            testLights = new Array(testLightsNum);
            for (var i = 0; i < testLightsNum; i++) {
                testLights[i] = new lights.Light();
                testLights[i].name = 'test light ' + i;
                testLights[i].groupID = testGroup._id;
            }

            var count: number = 0;
            for (var i = 0; i < testLightsNum; i++) {
                lights.create(testLights[i], (result) => {
                    testLights[i] = result;
                    count++;
                    if (count == testLightsNum) done();
                });
            }
        });

        it('should update groupID of lights of group', (done) => {
            groups.remove(testGroup._id, (result) => {
                expect(result.lights).toBe(testLightsNum);
                expect(result.groups).toBe(1);
                done();
            });
        });

        it('remove test lights', (done) => {
            var count: number = 0;
            for (var i = 0; i < testLightsNum; i++) {
                lights.remove(testLights[i]._id, (num) => {
                    count++;
                    if (count == testLightsNum) done();
                });
            }
        });
    });
});